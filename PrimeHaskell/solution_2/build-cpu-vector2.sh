#!/bin/bash

# get cpu list with 
#   llc --march=x86-64 --mcpu=help

ARCH="x86-64"
TRIPLE="x86_64-pc-linux-gnu"
CPU="$1"
echo "CPU is $CPU"

# what are these?
# GHC Platform-specific options
#              -mbmi2 -msse2 -msse4.2

rm -rf target tmp
mkdir -p target tmp
ghc -v -o target/Primes -outputdir target \
    -keep-tmp-files -tmpdir ./tmp \
    -O2 -fllvm -v \
    -mavx -mavx2 \
    -pgmlo /usr/lib/llvm-12/bin/opt \
    -pgmlc /usr/lib/llvm-12/bin/llc \
    -optlc -O3 -optlc -mtriple=$TRIPLE -optlc -march=$ARCH -optlc -mcpu=$CPU -optlc -mattr=+avx,+avx2 -optlc --vectorize-slp \
    -optlo -O3 -optlo -mtriple=$TRIPLE -optlo -march=$ARCH -optlo -mcpu=$CPU -optlo -mattr=+avx,+avx2 \
    -optlo --tti \
    -optlo --targetlibinfo \
    -optlo --tbaa \
    -optlo --scoped-noalias-aa \
    -optlo --assumption-cache-tracker \
    -optlo --profile-summary-info \
    -optlo --annotation2metadata \
    -optlo --forceattrs \
    -optlo --inferattrs \
    -optlo --domtree \
    -optlo --callsite-splitting \
    -optlo --ipsccp \
    -optlo --called-value-propagation \
    -optlo --globalopt \
    -optlo --domtree \
    -optlo --mem2reg \
    -optlo --deadargelim \
    -optlo --domtree \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --loops \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --instcombine \
    -optlo --simplifycfg \
    -optlo --basiccg \
    -optlo --globals-aa \
    -optlo --prune-eh \
    -optlo --inline \
    -optlo --function-attrs \
    -optlo --argpromotion \
    -optlo --domtree \
    -optlo --sroa \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --memoryssa \
    -optlo --early-cse-memssa \
    -optlo --speculative-execution \
    -optlo --aa \
    -optlo --lazy-value-info \
    -optlo --jump-threading \
    -optlo --correlated-propagation \
    -optlo --simplifycfg \
    -optlo --domtree \
    -optlo --aggressive-instcombine \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --loops \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --instcombine \
    -optlo --libcalls-shrinkwrap \
    -optlo --loops \
    -optlo --postdomtree \
    -optlo --branch-prob \
    -optlo --block-freq \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --pgo-memop-opt \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --loops \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --tailcallelim \
    -optlo --simplifycfg \
    -optlo --reassociate \
    -optlo --domtree \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --memoryssa \
    -optlo --loops \
    -optlo --loop-simplify \
    -optlo --lcssa-verification \
    -optlo --lcssa \
    -optlo --scalar-evolution \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --licm \
    -optlo --loop-rotate \
    -optlo --licm \
    -optlo --loop-unswitch \
    -optlo --simplifycfg \
    -optlo --domtree \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --loops \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --instcombine \
    -optlo --loop-simplify \
    -optlo --lcssa-verification \
    -optlo --lcssa \
    -optlo --scalar-evolution \
    -optlo --loop-idiom \
    -optlo --indvars \
    -optlo --loop-deletion \
    -optlo --loop-unroll \
    -optlo --sroa \
    -optlo --aa \
    -optlo --mldst-motion \
    -optlo --phi-values \
    -optlo --aa \
    -optlo --memdep \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --gvn \
    -optlo --sccp \
    -optlo --demanded-bits \
    -optlo --bdce \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --instcombine \
    -optlo --lazy-value-info \
    -optlo --jump-threading \
    -optlo --correlated-propagation \
    -optlo --postdomtree \
    -optlo --adce \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --memoryssa \
    -optlo --memcpyopt \
    -optlo --loops \
    -optlo --dse \
    -optlo --loop-simplify \
    -optlo --lcssa-verification \
    -optlo --lcssa \
    -optlo --aa \
    -optlo --scalar-evolution \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --licm \
    -optlo --simplifycfg \
    -optlo --domtree \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --loops \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --instcombine \
    -optlo --barrier \
    -optlo --elim-avail-extern \
    -optlo --basiccg \
    -optlo --rpo-function-attrs \
    -optlo --globalopt \
    -optlo --globaldce \
    -optlo --basiccg \
    -optlo --globals-aa \
    -optlo --domtree \
    -optlo --float2int \
    -optlo --lower-constant-intrinsics \
    -optlo --loops \
    -optlo --loop-simplify \
    -optlo --lcssa-verification \
    -optlo --lcssa \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --scalar-evolution \
    -optlo --loop-rotate \
    -optlo --loop-accesses \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --loop-distribute \
    -optlo --postdomtree \
    -optlo --branch-prob \
    -optlo --block-freq \
    -optlo --scalar-evolution \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --loop-accesses \
    -optlo --demanded-bits \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --inject-tli-mappings \
    -optlo --loop-vectorize \
    -optlo --loop-simplify \
    -optlo --scalar-evolution \
    -optlo --aa \
    -optlo --loop-accesses \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --loop-load-elim \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --instcombine \
    -optlo --simplifycfg \
    -optlo --domtree \
    -optlo --loops \
    -optlo --scalar-evolution \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --demanded-bits \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --inject-tli-mappings \
    -optlo --slp-vectorizer \
    -optlo --vector-combine \
    -optlo --opt-remark-emitter \
    -optlo --instcombine \
    -optlo --loop-simplify \
    -optlo --lcssa-verification \
    -optlo --lcssa \
    -optlo --scalar-evolution \
    -optlo --loop-unroll \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --instcombine \
    -optlo --memoryssa \
    -optlo --loop-simplify \
    -optlo --lcssa-verification \
    -optlo --lcssa \
    -optlo --scalar-evolution \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --licm \
    -optlo --opt-remark-emitter \
    -optlo --transform-warning \
    -optlo --alignment-from-assumptions \
    -optlo --strip-dead-prototypes \
    -optlo --globaldce \
    -optlo --constmerge \
    -optlo --mergefunc \
    -optlo --cg-profile \
    -optlo --domtree \
    -optlo --loops \
    -optlo --postdomtree \
    -optlo --branch-prob \
    -optlo --block-freq \
    -optlo --loop-simplify \
    -optlo --lcssa-verification \
    -optlo --lcssa \
    -optlo --basic-aa \
    -optlo --aa \
    -optlo --scalar-evolution \
    -optlo --block-freq \
    -optlo --loop-sink \
    -optlo --lazy-branch-prob \
    -optlo --lazy-block-freq \
    -optlo --opt-remark-emitter \
    -optlo --instsimplify \
    -optlo --div-rem-pairs \
    -optlo --simplifycfg \
    -optlo --annotation-remarks \
    Primes.hs
